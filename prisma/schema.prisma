// Prisma schema for Malewa-Fac (MySQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  client
  merchant
  courier
  admin
  superadmin
  dispatcher
  agent
}

enum UserStatus {
  active
  suspended
  pending
}

enum OrderStatus {
  pending_confirmation // New status for dispatcher validation
  received
  preparing
  ready
  delivering
  delivered
  rejected
}

enum DeliveryMethod {
  pickup
  campus
  offcampus
}

enum PaymentMethod {
  mobile
  card
  cod
}

enum DeliveryMissionStatus {
  available
  accepted
  picked
  enroute
  delivered
}

enum Beneficiary {
  merchant
  courier
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
}

model Institution {
  id    Int     @id @default(autoincrement())
  code  String  @unique
  name  String
  users User[]
  restaurantLinks RestaurantInstitution[]
}

model User {
  id             Int        @id @default(autoincrement())
  name           String
  email          String?    @unique
  phone          String?    @unique
  paymentPhoneNumber String? // For merchants/couriers to receive payments
  passwordHash   String?
  role           UserRole
  status         UserStatus @default(active)
  institutionId  Int?
  institution    Institution? @relation(fields: [institutionId], references: [id])
  otp            String?
  otpExpiresAt   DateTime?
  restaurants    Restaurant[] @relation("RestaurantOwner")
  managedRestaurants RestaurantAgent[]
  orders         Order[]      @relation("OrderCustomer")
  missions       DeliveryMission[] @relation("MissionCourier")
  notifications  Notification[]
  supportTickets SupportTicket[]
  promoCodes     PromoCode[]  @relation("PromoCodeOwner")
  promoCodeUsages PromoCodeUsage[] @relation("PromoCodeUsedBy")
  ownedVouchers  DiscountVoucher[] @relation("VoucherOwner")
  usedVouchers   DiscountVoucher[] @relation("VoucherUsedBy")
  sharedVouchers DiscountVoucher[] @relation("VoucherSharedTo")
  promoCodeRequests PromoCodeRequest[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

enum RestaurantStatus {
  pending
  active
  rejected
  suspended
}

model Restaurant {
  id                 Int       @id @default(autoincrement())
  code               String?   @unique
  name               String
  status             RestaurantStatus @default(pending)
  rejectionReason    String?
  address            String?
  description        String?   @db.Text
  institutionLinks   RestaurantInstitution[]
  ownerUserId        Int?
  owner              User?      @relation("RestaurantOwner", fields: [ownerUserId], references: [id])
  agents             RestaurantAgent[]
  rating             Decimal?   @db.Decimal(3, 2)
  deliveryFeeCampus  Int        @default(1000)
  isAvailable        Boolean    @default(true)
  openingTime        String?    @default("10:00")
  closingTime        String?    @default("15:00")
  photoUrl           String?
  createdAt          DateTime   @default(now())
  dishes             Dish[]
  categories         DishCategory[]
  orders             Order[]
  missions           DeliveryMission[]
}

model RestaurantAgent {
  id           Int        @id @default(autoincrement())
  userId       Int
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, restaurantId])
}

model DishCategory {
  id           Int        @id @default(autoincrement())
  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  name         String
  displayOrder Int        @default(0)
  createdAt    DateTime   @default(now())
  dishes       Dish[]

  @@unique([restaurantId, name])
}

model RestaurantInstitution {
  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  institutionId Int
  institution   Institution @relation(fields: [institutionId], references: [id])

  @@id([restaurantId, institutionId])
}

model Dish {
  id           Int        @id @default(autoincrement())
  code         String?    @unique
  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  name         String
  description  String?
  price        Int
  photoUrl     String?
  available    Boolean    @default(true)
  categoryId   Int?
  category     DishCategory? @relation(fields: [categoryId], references: [id])
  isFlexiblePrice Boolean @default(false)
  isMandatory  Boolean    @default(false)
  minPrice     Int?     @default(0)
  options      DishOption[]
  createdAt    DateTime   @default(now())
  orderItems   OrderItem[]

  @@unique([restaurantId, name])
}

model DishOption {
  id        Int     @id @default(autoincrement())
  dishId    Int
  dish      Dish    @relation(fields: [dishId], references: [id], onDelete: Cascade)
  name      String
  price     Int
  isMandatory Boolean @default(false)
}

model Order {
  id                 Int          @id @default(autoincrement())
  code               String       @unique
  customerUserId     Int
  customer           User         @relation("OrderCustomer", fields: [customerUserId], references: [id])
  customerName       String
  restaurantId       Int
  restaurant         Restaurant   @relation(fields: [restaurantId], references: [id])
  subtotal           Int
  serviceFee         Int
  deliveryMethod     DeliveryMethod
  deliveryFee        Int
  total              Int
  discount           Int          @default(0)
  promoCodeUsed      String?
  voucherUsed        String?
  paymentMethod      PaymentMethod
  address            String?
  notes              String?      @db.Text
  estimatedDistanceKm Float?
  status             OrderStatus  @default(received)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  items              OrderItem[]
  missions           DeliveryMission[]
  payments           Payment[]
  transactions       Transaction[]
  promoCodeUsages    PromoCodeUsage[]
  voucherUsages      DiscountVoucher[]
}

model OrderItem {
  id          Int   @id @default(autoincrement())
  orderId     Int
  order       Order @relation(fields: [orderId], references: [id])
  dishId      Int
  dish        Dish  @relation(fields: [dishId], references: [id])
  name        String
  price       Int
  customPrice Int?
  qty         Int
  options     OrderItemOption[]
}

model OrderItemOption {
  id          Int       @id @default(autoincrement())
  orderItemId Int
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  name        String
  price       Int
}

model DeliveryMission {
  id                  Int        @id @default(autoincrement())
  orderId             Int
  order               Order      @relation(fields: [orderId], references: [id])
  restaurantId        Int
  restaurant          Restaurant @relation(fields: [restaurantId], references: [id])
  courierUserId       Int?
  courier             User?      @relation("MissionCourier", fields: [courierUserId], references: [id])
  restaurantLocation  String
  customerLocation    String
  customerPhone       String
  status              DeliveryMissionStatus @default(available)
  earning             Int
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
}

model Payment {
  id           Int          @id @default(autoincrement())
  orderId      Int
  order        Order        @relation(fields: [orderId], references: [id])
  method       PaymentMethod
  provider     String?
  providerRef  String?
  amount       Int
  status       PaymentStatus @default(pending)
  paidAt       DateTime?
  createdAt    DateTime      @default(now())
}

model Transaction {
  id           Int          @id @default(autoincrement())
  orderId      Int
  order        Order        @relation(fields: [orderId], references: [id])
  beneficiary  Beneficiary
  amount       Int
  commission   Int          @default(0)
  netAmount    Int
  status       String       @default("pending")
  createdAt    DateTime     @default(now())
}

model Setting {
  id     Int    @id @default(autoincrement())
  skey   String @unique
  svalue String @db.LongText
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  type      String
  title     String
  message   String?
  data      Json?
  readAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId, readAt])
  @@index([userId, createdAt])
}

enum TicketStatus {
  open
  resolved
  closed
}

enum TicketPriority {
  low
  medium
  high
}

model SupportTicket {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  subject     String
  message     String   @db.Text
  status      TicketStatus @default(open)
  priority    TicketPriority @default(medium)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== PROMO CODE SYSTEM ====================

enum PromoCodeRequestStatus {
  pending
  approved
  rejected
}

enum DiscountVoucherStatus {
  active
  used
  expired
  transferred
}

model PromoCode {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  ownerUserId Int
  owner       User     @relation("PromoCodeOwner", fields: [ownerUserId], references: [id])
  points      Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  usages      PromoCodeUsage[]
}

model PromoCodeUsage {
  id           Int       @id @default(autoincrement())
  promoCodeId  Int
  promoCode    PromoCode @relation(fields: [promoCodeId], references: [id])
  orderId      Int
  order        Order     @relation(fields: [orderId], references: [id])
  usedByUserId Int
  usedBy       User      @relation("PromoCodeUsedBy", fields: [usedByUserId], references: [id])
  createdAt    DateTime  @default(now())

  @@unique([promoCodeId, orderId])
}

model DiscountVoucher {
  id              Int                   @id @default(autoincrement())
  code            String                @unique
  ownerUserId     Int
  owner           User                  @relation("VoucherOwner", fields: [ownerUserId], references: [id])
  discountPercent Int                   @default(10)
  status          DiscountVoucherStatus @default(active)
  usedByUserId    Int?
  usedBy          User?                 @relation("VoucherUsedBy", fields: [usedByUserId], references: [id])
  usedOnOrderId   Int?
  usedOnOrder     Order?                @relation(fields: [usedOnOrderId], references: [id])
  sharedToUserId  Int?
  sharedTo        User?                 @relation("VoucherSharedTo", fields: [sharedToUserId], references: [id])
  expiresAt       DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

model PromoCodeRequest {
  id        Int                    @id @default(autoincrement())
  userId    Int
  user      User                   @relation(fields: [userId], references: [id])
  status    PromoCodeRequestStatus @default(pending)
  reason    String?                @db.Text
  adminNote String?                @db.Text
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
}
